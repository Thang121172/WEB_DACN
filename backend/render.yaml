import os
from decouple import config
import dj_database_url

# Build paths inside the project like this: BASE_DIR / 'subdir'.
from pathlib import Path

# Thư mục gốc của dự án Django
BASE_DIR = Path(__file__).resolve().parent.parent

# --- Biến Môi trường (Environment Variables) ---
# Sử dụng python-decouple để đọc các biến từ .env (cho môi trường local)
# hoặc từ môi trường hệ thống (cho Render/Production)

# KHÓA BÍ MẬT (SECRET KEY) - Rất quan trọng cho bảo mật
# Sử dụng một giá trị mặc định cho local (chỉ để phát triển),
# Render sẽ tự động thay thế bằng một khóa bảo mật.
SECRET_KEY = config('SECRET_KEY', 'django-insecure-default-secret-key-for-local-development')

# MÔI TRƯỜNG: Production (Render) hoặc Development (Local)
ENVIRONMENT = config('ENVIRONMENT', default='Development')

# DEBUG: Tắt DEBUG khi triển khai lên Production
DEBUG = ENVIRONMENT == 'Development'

# --- Cấu hình Hosts an toàn ---
ALLOWED_HOSTS = ['127.0.0.1', 'localhost']
# Thêm hostname của Render nếu nó tồn tại
RENDER_EXTERNAL_HOSTNAME = config('RENDER_EXTERNAL_HOSTNAME', default=None)
if RENDER_EXTERNAL_HOSTNAME:
    ALLOWED_HOSTS.append(RENDER_EXTERNAL_HOSTNAME)
    # Thêm domain của Render theo định dạng <tên-dịch-vụ>.onrender.com
    # Ví dụ: fastfood-backend.onrender.com
    ALLOWED_HOSTS.append(RENDER_EXTERNAL_HOSTNAME.split(':')[0])

# --- Cấu hình Ứng dụng ---
INSTALLED_APPS = [
    'django.contrib.admin',
    'django.contrib.auth',
    'django.contrib.contenttypes',
    'django.contrib.sessions',
    'django.contrib.messages',
    'django.contrib.staticfiles',
    
    # Thư viện bên thứ 3
    'rest_framework',
    'corsheaders',
    'drf_spectacular',
    'django_celery_results',
    'django_celery_beat',
    'django_prometheus',

    # Ứng dụng của bạn
    # Thêm các app của dự án tại đây, ví dụ:
    # 'apps.users',
    # 'apps.products',
]

MIDDLEWARE = [
    # Prometheus (Cần ở đầu tiên)
    'django_prometheus.middleware.PrometheusBeforeMiddleware',

    # Cors Headers (Cần ở đầu tiên)
    'corsheaders.middleware.CorsMiddleware',
    
    'django.middleware.security.SecurityMiddleware',
    
    # WhiteNoise cho Static Files (Cần ở đây)
    'whitenoise.middleware.WhiteNoiseMiddleware',
    
    'django.contrib.sessions.middleware.SessionMiddleware',
    'django.middleware.common.CommonMiddleware',
    'django.middleware.csrf.CsrfViewMiddleware',
    'django.contrib.auth.middleware.AuthenticationMiddleware',
    'django.contrib.messages.middleware.MessageMiddleware',
    'django.middleware.clickjacking.XFrameOptionsMiddleware',

    # Prometheus (Cần ở cuối cùng)
    'django_prometheus.middleware.PrometheusAfterMiddleware',
]

# --- CORS Headers ---
# Cho phép tất cả các nguồn gốc (Chỉ nên dùng cho mục đích phát triển hoặc API công khai)
# Trong môi trường Production, bạn nên thay thế bằng một danh sách cụ thể (CORS_ALLOWED_ORIGINS)
CORS_ALLOW_ALL_ORIGINS = True 

ROOT_URLCONF = 'fastfood.urls'

TEMPLATES = [
    {
        'BACKEND': 'django.template.backends.django.DjangoTemplates',
        'DIRS': [],
        'APP_DIRS': True,
        'OPTIONS': {
            'context_processors': [
                'django.template.context_processors.debug',
                'django.template.context_processors.request',
                'django.contrib.auth.context_processors.auth',
                'django.contrib.messages.context_processors.messages',
            ],
        },
    },
]

WSGI_APPLICATION = 'fastfood.wsgi.application'


# --- Cấu hình Cơ sở dữ liệu ---
# Đọc DATABASE_URL từ biến môi trường (Render hoặc .env)
# và phân tích nó thành cấu hình cơ sở dữ liệu Django.
# Nếu DATABASE_URL không tồn tại (ví dụ: chưa cài .env hoặc Render chưa inject), 
# nó sẽ dùng SQLite mặc định (chỉ dùng cho phát triển).
DATABASE_URL = config('DATABASE_URL', default=f'sqlite:///{BASE_DIR / "db.sqlite3"}')

DATABASES = {
    'default': dj_database_url.parse(DATABASE_URL)
}


# --- Cấu hình Mật khẩu và Xác thực ---
AUTH_PASSWORD_VALIDATORS = [
    {'NAME': 'django.contrib.auth.password_validation.UserAttributeSimilarityValidator'},
    {'NAME': 'django.contrib.auth.password_validation.MinimumLengthValidator'},
    {'NAME': 'django.contrib.auth.password_validation.CommonPasswordValidator'},
    {'NAME': 'django.contrib.auth.password_validation.NumericPasswordValidator'},
]


# --- Cấu hình Ngôn ngữ & Múi giờ ---
LANGUAGE_CODE = 'en-us'

TIME_ZONE = 'Asia/Ho_Chi_Minh'

USE_I18N = True

USE_TZ = True


# --- Static files (CSS, JavaScript, Images) ---
# Thư mục để Django tìm kiếm các file tĩnh trong các ứng dụng.
STATIC_URL = 'static/'

# STATIC_ROOT: Đường dẫn tuyệt đối nơi collectstatic sẽ thu thập tất cả các file tĩnh.
# Cần thiết cho Production.
STATIC_ROOT = BASE_DIR / 'staticfiles'

# WhiteNoise sẽ quản lý các file tĩnh
STORAGES = {
    "staticfiles": {
        "BACKEND": "whitenoise.storage.CompressedManifestStaticFilesStorage",
    },
}

# --- Default primary key field type ---
DEFAULT_AUTO_FIELD = 'django.db.models.BigAutoField'


# --- Cấu hình DRF ---
REST_FRAMEWORK = {
    'DEFAULT_SCHEMA_CLASS': 'drf_spectacular.openapi.AutoSchema',
    'DEFAULT_AUTHENTICATION_CLASSES': (
        'rest_framework_simplejwt.authentication.JWTAuthentication',
    ),
}

# --- Cấu hình DRF Spectacular (OpenAPI/Swagger) ---
SPECTACULAR_SETTINGS = {
    'TITLE': 'FastFood API Project',
    'DESCRIPTION': 'REST API cho dự án FastFood',
    'VERSION': '1.0.0',
    'SERVE_INCLUDE_SCHEMA': False, # Tắt tính năng này trên Production
}

# --- Cấu hình Celery ---
# Cần cấu hình broker và backend cho Celery
CELERY_BROKER_URL = config('CELERY_BROKER_URL', default='redis://localhost:6379/0')
CELERY_RESULT_BACKEND = 'django-db' # Lưu kết quả vào cơ sở dữ liệu Django

# Múi giờ cần khớp với TIME_ZONE của Django
CELERY_TIMEZONE = TIME_ZONE

# Celery Beat
CELERY_BEAT_SCHEDULER = 'django_celery_beat.schedulers:DatabaseScheduler'